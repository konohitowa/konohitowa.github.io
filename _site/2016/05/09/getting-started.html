<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Piros: A Rust OS on a Raspberry Pi</title>
    <link rel="stylesheet" href="/stylesheets/styles.css">
    <link rel="stylesheet" href="/stylesheets/github-dark.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/javascripts/respond.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="stylesheets/ie.css">
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>

<body class="wrap">
        <div id="header">
        <nav>
          <li class="fork"><a href="https://github.com/konohitowa/piros">View Companion Code on GitHub</a></li>
          <li class="downloads"><a href="/">Home</a></li>
          <li class="title"><a href="/about.html">About</a></li>
        </nav>
      </div><!-- end header -->

    <div class="wrapper">
      <section>
        <div id="title">
          <h2>Piros: A Rust OS on a Raspberry Pi</h2>
          <p></p>
          <hr>
          <span class="credits left">Project maintained by <a href="https://github.com/konohitowa">konohitowa</a></span>
          <span class="credits right">Hosted on GitHub Pages &mdash; Theme by <a href="https://twitter.com/michigangraham">mattgraham</a></span>
        </div>


  <p>This section covers the hardware and software tools you’ll need to follow along. I’ll cover what I used and try to point out alternatives if I’m aware of them. Constructive comments are always welcome.</p>

<p>If you haven’t read the <a href="/about.html">about</a>, do that first. It contains links to the originating projects used on this blog and other details.</p>

<h3 id="note">Note</h3>
<hr />
<p>When I first started this project, I was using my MacBook as a host (OS X.11) and built the aarch64-none-elf toolchain to cross compile my code. I was able to do this because I was using C. When I switched to Rust, I had to switch to the aarch64-linux-gnu toolchain because the Rust compiler doesn’t currently have support for aarch64-none-elf, and I don’t know enough about the compiler to add that support. After a lot of hours trying to get aarch64-linux-gnu to build – I even resorted to crosstool-ng which seemed like having to hire the <em>Geek Squad</em> to come fix my computer – I finally gave in and switched to my Ubuntu VM. My instructions will be targeted toward Ubuntu 14.04 LTS. If you can make the appropriate translations to something else, feel free. In fact, if you can build aarch64-linux-gnu for OS X, please do and release it to MacPorts!</p>

<hr />

<h3 id="required-items">Required Items</h3>
<ul>
  <li>A <a href="https://www.raspberrypi.org/products/raspberry-pi-3-model-b/">Raspberry Pi 3 Model B</a>. I got mine from Newark (element14 for personal orders).</li>
  <li>A Micro SD card from which your software will load. The Raspberry Pi folks recommend getting an 8GB class 4 (4 MB/s) card and we <em>will</em> be loading it with Linux to start out. I actually got mine from Staples because I brought my 3B into work when it came in the mail (all excited) and forgot that I’d need one.</li>
  <li>A Micro SD adapter. You’re going to need to be able to mount and write to Micro SD cards. My laptop has an SD slot so I used one of the SD to Micro SD adapter shells. If you’re not in a rush to buy a Micro SD card at Staples due to poor planning, you can likely find a card that comes with the SD adapter. I’ve since switched to a USB adapter that handles a bunch of different formats. I had it lying around the house and, as it turns out, using the SD adapter required me to unseat and reseat it on my MacBook to get it to mount – which was a pain.</li>
  <li>A USB to TTL serial converter. This is because our I/O will be serial-based rather than via a monitor and attached keyboard. I got a JBtek adapter from Amazon because I have Prime so it was $7 US delivered. It also provides power to the 3B which has so far been sufficient. The downside to using it for power is that you need to have a serial console that can immediately connect to the USB interface when you plug it in. I’ve been using Serial for that on OS X. It’s $30 US. Ouch. There may have been beer involved in that purchase.</li>
  <li>A micro USB cable for powering the 3B from your computer or other powered USB peripheral (phone charger, etc).</li>
  <li>The <a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian Jessie</a> install.</li>
</ul>

<h3 id="optional-items">Optional Items</h3>
<ul>
  <li>A decent micro USB power supply rather than the cable+USB-power. The 3B seems a bit picky about its power (lots of rainbow boxes fading in and out). I ended up spending $10 on the CanaKit 2.5A – again, from Amazon – which cleared that issue. It ultimately wasn’t strictly necessary, but I was trying to sort a serial I/O issue and wanted to eliminate power as a possible problem. You might also want one if you don’t care to power your 3B via the USB-TTL adapter (which I recommend against for most users).</li>
</ul>

<p>A <a href="https://www.raspberrypi.org/documentation/setup/">more comprehensive list of requirements</a> can be found at the Raspberry Pi website.</p>

<h3 id="running-raspbian-with-a-serial-console">Running Raspbian with a Serial Console</h3>
<p>The first thing we want to do is get Raspbian installed on our Micro SD card using the <a href="https://www.raspberrypi.org/documentation/installation/installing-images/README.md">installation instructions</a> at the Raspberry Pi website. If you have an HDMI capable monitor (HDMI is a superset of DVI, so HDMI to DVI adapters are readily available) and a USB keyboard &amp; mouse, you can try out your newly installed image by plugging everything together and providing power via a micro USB adapter. You should see a typical Linux boot sequence followed by a desktop. If you see a rainbow looking square occasionally appear on the upper right side of the screen, that’s the 3B complaining about its power quality. The only way I was able to get rid of that was via the power supply mentioned in the <strong>Optional Items</strong> list. That was after trying every cable and USB power source I had. I suppose I could have wired up a USB A male adapter to my bench supply, but ordering a dedicated supply seemed like a better idea. If it makes you feel any better, I noticed no ill effects from this – it was primarily an annoyance.</p>

<p>If you don’t have an HDMI monitor or you just want to skip straight to the serial I/O, now comes the part where we mess with the hardware. You can easily fry components hooking up the USB/TTL serial adapter. You can also fry components by trying to power your 3B from both the adapter and the micro USB port. Be careful, and take your time to get it right.</p>

<p>The documentation that came with my JBtek was rather sparse. So sparse, in fact, that there wasn’t any. Figuring out how to connect it to the 3B took some digging around the dark corners of the internet. Okay, that’s probably overly dramatic, but it wasn’t trivial. Like most things, after reading datasheets and digging about, I found the bulk of what I needed via a link at the Raspberry Pi website.</p>

<p>The Broadcom chip in the 3B has two UARTs (Universal Asynchronous Receiver/Transmitter). One of them is used by Bluetooth so we’ll be using what they call the miniUART which is mapped to the GPIO pins (the 40 pins on the edge of the board arranged in two rows of 20 pins each). Take a look at <a href="http://pinout.xyz/">gadgetoid’s awesome Raspberry Pi pinout</a> diagram. We’ll only be using 3-pins for communications: <a href="http://pinout.xyz/pinout/pin8_gpio14">Pin 8 - Transmit Data (TXD)</a>, <a href="http://pinout.xyz/pinout/pin10_gpio15">Pin 10 - Receive Data (RXD)</a>, and a ground reference - in our case, <a href="http://pinout.xyz/pinout/ground">Pin 6 - Ground</a>. We could have used any of the grounds, but pin 6 is next to others which is more convenient. On my JBtek, I have 4 wires coming out the end: red, black, white, and green. For now, we’re going to ignore the red wire. I plugged the black wire into ground (pin 6), the white wire into transmit (pin 8), and the green wire into receive (pin 10). If your wire colors are different you’ll need to figure out which is which. Either find some documentation for your adapter, or leave a comment here and I’ll see if I can help you out. The one thing to keep in mind is that the <em>Transmit</em> wire on your adapter goes to the Receive pin on the 3B, and the <em>Receive</em> pin on your adapter goes to the Transmit pin on the 3B; i.e., the names are swapped. The signals are named from the perspective of the originator, so the 3B is transmitting to something that is receiving, and <em>vice versa</em>.</p>

<p>At this point, I would strongly suggest leaving the red wire unhooked and powering the 3B from the micro USB port. If you absolutely are just dying to power your 3B exclusively from the USB-TTL adapter, <a href="/the-red-wire.html">the instructions are here</a>. You’ll also do well to have a monitor attached because you can see what’s going on fairly clearly.</p>

<p>Finally, you’ll need a serial console program. Like I said, I plunked down $30 US for Serial from the Mac App store (not before using up the 7-day trial period and finding a liked it), but there are many options. I also like <code class="highlighter-rouge">miniterm.py</code> which comes with the python serial package (on Ubuntu: <code class="highlighter-rouge">sudo apt-get install python-serial</code>); people who never use Ctrl-A to go to the start of a line in the shell seem to like <code class="highlighter-rouge">screen</code> (I’m not one of them); but find something that works for you. You’re going to use communication parameters of 115200 baud, 8 data bits, no parity bit, 1 stop bit (115200 8 N 1). If you use miniterm, a typical startup will be <code class="highlighter-rouge">miniterm.py /dev/ttyUSB0 115200</code>. If you’re on Linux, you’ll really want to add yourself to the dialout group so you don’t have to use <code class="highlighter-rouge">sudo</code> to launch miniterm, screen, cu, or whatever. I usually just edit the /etc/group file as root and add my username after the colon at the end of the line that starts with <code class="highlighter-rouge">dialout</code>, then log out and back in again. Or you can <code class="highlighter-rouge">sudo adduser &lt;your user name&gt; dialout</code> and then logout and back in again.</p>

<p>Now we’re ready to try out our serial console. Plug in your USB-TTL adapter and connect to it via whatever serial console you decided to use. Once you’ve done that, apply power via the micro USB cable and watch your glorious serial data come pouring out to your console (for those that are powering via “the red wire”, plug in the USB-TTL adapter <strong>only</strong> and then connect your console - if you’re quick about it, you should be to catch some of the data coming out).</p>

<p>What’s that? You only see a garbled mess? Yeah. Me too. Tracking down this problem was one of the reasons I bought the CanaKit power supply – in order to rule out bad power as part of the problem. I also bought a different brand of USB-TTL adapter. It’s a shame I don’t have a digital capture scope that can do protocol analysis. Wait – I do. &gt;_&gt;</p>

<p>As it turns out, the miniUART is clocked via the Broadcom’s core clock and running at default frequency (400MHz) it can’t divide its baud rate to 115200. We need to lower it to 250MHz to see serial output correctly. So power off your 3B, mount your micro SD card on your host machine, and add the following line to the config.txt file in the boot partition (the boot partition is a 60MB FAT32 formatted partition):</p>

<p><code class="highlighter-rouge">core_freq=250</code></p>

<p>If you are running your 3B with a monitor+keyboard+mouse, you can actually do it from there by opening the drive that mounts as “boot” and editing it in place. A lot of the tutorials I see recommend that you back up everything in your boot partiiton before you touch config.txt since borking it up can keep your 3B from booting, but we’re starting from a scratch system so absolute worst case is that you just reinstall Raspbian on your micro SD card and try again.</p>

<p>Okay. Unmount your micro SD card, put back in your 3B, and repeat the boot steps from above. <strong>Now</strong> you should have legible serial output. You can login if you want. The user is <strong>pi</strong> and the password is <strong>raspberry</strong>.</p>

<p>That wraps up <strong>Getting Started</strong>. Next time we’ll setup our Ubuntu VM (if necessary) and get some basic serial I/O working. Feel free to ask questions or leave feedback via the comments section below.</p>

<h3 id="troubleshooting">Troubleshooting</h3>
<ol>
  <li>Getting absolutely no serial output.
    <ol>
      <li>Is your communication software set up for 115200,8,N,1?</li>
      <li>Is your ground wire connected?</li>
      <li>Are your transmit and receive wires connected?</li>
      <li>You probably have your transmit and receive wires swapped. They’re 3.3V nominal, low current, and should be high impedance (resist short circuits). It’s highly unlikely you’ve caused any damage to anything by doing this.</li>
    </ol>
  </li>
</ol>


  <hr/>
<div>Disclaimer: Whenever you mess directly with hardware, you run the risk of damaging it. I take no responsibility for damage that may occur when using the information contained at this site. If you're unsure about anything, check &#151; doublecheck &#151; then check again. You can definitely fry things &#151; or worse &#151; by wiring them incorrectly or plugging things together without paying attention to what you're doing.</div>
<div id="disqus_thread"></div>
<script>
/**
* RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
* LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');

s.src = '//konohitowa.disqus.com/embed.js';

s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

      <!--[if !IE]><script>fixScale(document);</script><![endif]-->
    </div>


</body>
</html>